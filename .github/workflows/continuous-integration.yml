name: Continuous Integration

on: [push, pull_request]

jobs:
  Cmake:
    name: ${{ matrix.config.os_name }} | ${{ matrix.config.build_type }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
        - {
            os_name: "Windows",
            os: "windows-latest",
            shell: "msys2 {0}",
            cmake_generator: "MinGW Makefiles",
            build_type: "x86",
            msystem: "MINGW32",
            arch: "i686"
        }
        - {
            os_name: "Windows",
            os: "windows-latest",
            shell: "msys2 {0}",
            cmake_generator: "MinGW Makefiles",
            build_type: "x64",
            msystem: "MINGW64",
            arch: "x86_64"
        }
        - {
            os_name: "Linux",
            os: "ubuntu-latest",
            shell: "bash",
            cmake_generator: "Unix Makefiles",
            build_type: "x64"
        }
    defaults:
      run:
        shell: ${{ matrix.config.shell }}
    steps:
      - name: Setup MSYS
        if: ${{ matrix.config.os_name == 'Windows' }}
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.config.msystem }}
          update: false
          install: >-
            mingw-w64-${{ matrix.config.arch }}-pkgconf
            mingw-w64-${{ matrix.config.arch }}-gcc
            mingw-w64-${{ matrix.config.arch }}-make
            mingw-w64-${{ matrix.config.arch }}-cmake
            mingw-w64-${{ matrix.config.arch }}-SDL2
            mingw-w64-${{ matrix.config.arch }}-SDL2_net
            mingw-w64-${{ matrix.config.arch }}-SDL2_mixer
            mingw-w64-${{ matrix.config.arch }}-libsamplerate
            mingw-w64-${{ matrix.config.arch }}-libpng

      - name: Install Dependencies
        if: ${{ matrix.config.os_name == 'Linux' }}
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install --fix-missing gcc make cmake libsdl2-dev libsdl2-net-dev libsdl2-mixer-dev libpng-dev libsamplerate-dev

      - uses: actions/checkout@v2

      - name: Configure
        id: configure
        run: |
          sha_short=$(echo ${{ github.sha }} | cut -c1-7)
          cmake -G"${{ matrix.config.cmake_generator }}" -DBUILD_VERSION_OVERWRITE="$sha_short" -DCMAKE_BUILD_TYPE=Release -S . -B build
          echo "::set-output name=sha_short::$sha_short"

      - name: Build
        run: |
          export MAKEFLAGS=--keep-going
          cmake --build build --parallel 2

      - name: Install
        if: ${{ github.repository == 'JNechaevsky/russian-doom' && github.event_name == 'push' && github.ref == 'refs/heads/master' && matrix.config.os_name == 'Windows' }}
        run: |
          cmake --install build --prefix "./build/install"

      - name: Package
        if: ${{ github.repository == 'JNechaevsky/russian-doom' && github.event_name == 'push' && github.ref == 'refs/heads/master' && matrix.config.os_name == 'Windows' }}
        uses: actions/upload-artifact@v2
        with:
          name: russian-doom-${{ steps.configure.outputs.sha_short }}-windows-${{ matrix.config.build_type }}
          path: ./build/install/

  Autotools:
    name: Autotools | Linux | x64
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        shell: bash
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install --fix-missing gcc make automake libsdl2-dev libsdl2-net-dev libsdl2-mixer-dev libpng-dev libsamplerate-dev

      - uses: actions/checkout@v2

      - name: Configure
        shell: bash
        run: |
          ./autogen.sh

      - name: Build
        shell: bash
        run: |
          export MAKEFLAGS=--keep-going
          make -j 2