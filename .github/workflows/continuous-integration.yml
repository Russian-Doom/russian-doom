name: Continuous Integration

on: [push, pull_request]

jobs:
  Cmake:
    name: ${{ matrix.config.os_name }} | ${{ matrix.config.build_type }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
        - {
            os_name: "Windows",
            os: "windows-latest",
            shell: "msys2 {0}",
            cmake_generator: "MinGW Makefiles",
            build_type: "x86",
            msystem: "MINGW32",
            arch: "i686"
        }
        - {
            os_name: "Windows",
            os: "windows-latest",
            shell: "msys2 {0}",
            cmake_generator: "MinGW Makefiles",
            build_type: "x64",
            msystem: "MINGW64",
            arch: "x86_64"
        }
        - {
            os_name: "Linux",
            os: "ubuntu-latest",
            shell: "bash",
            cmake_generator: "Unix Makefiles",
            build_type: "x64"
        }
    defaults:
      run:
        shell: ${{ matrix.config.shell }}
    steps:
      - name: Setup MSYS
        if: ${{ matrix.config.os_name == 'Windows' }}
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.config.msystem }}
          update: true
          install: >-
            mingw-w64-${{ matrix.config.arch }}-toolchain
            mingw-w64-${{ matrix.config.arch }}-cmake
            mingw-w64-${{ matrix.config.arch }}-SDL2
            mingw-w64-${{ matrix.config.arch }}-SDL2_net
            mingw-w64-${{ matrix.config.arch }}-SDL2_mixer
            mingw-w64-${{ matrix.config.arch }}-libsamplerate
            mingw-w64-${{ matrix.config.arch }}-libpng

      - name: Install Dependencies
        if: ${{ matrix.config.os_name == 'Linux' }}
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install --fix-missing gcc make cmake libsdl2-dev libsdl2-net-dev libsdl2-mixer-dev libpng-dev libsamplerate-dev

      - uses: actions/checkout@v2

      - name: Configure
        run: |
          cmake -G"${{ matrix.config.cmake_generator }}" -DCMAKE_BUILD_TYPE=Release -S . -B build

      - name: Build
        run: |
          export MAKEFLAGS=--keep-going
          cmake --build build --parallel 2

  Autotools:
    name: Autotools | Linux | x64
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        shell: bash
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install --fix-missing gcc make automake libsdl2-dev libsdl2-net-dev libsdl2-mixer-dev libpng-dev libsamplerate-dev

      - uses: actions/checkout@v2

      - name: Configure
        shell: bash
        run: |
          ./autogen.sh

      - name: Build
        shell: bash
        run: |
          export MAKEFLAGS=--keep-going
          make -j 2